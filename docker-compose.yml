version: '3.4'
services:

  app:
    build: .
    image: &img app
    command: ["python", "app.py"]
    environment: &env
      - CELERY_BROKER_URL=amqp://guest:guest@rabbitmq:5672
      - FLASK_ENV=development
    depends_on:
      - rabbitmq
    restart: 'no'
    ports:
      - 8000:8000
    volumes: 
      - ./app:/app

  worker:
    image: *img
    command: [celery, worker, --app=worker.app, --pool=prefork, --concurrency=1, --loglevel=INFO]
    environment: *env
    depends_on:
      - rabbitmq
    restart: 'no'
    volumes: 
      - ./app:/app

  rabbitmq:
    image: rabbitmq:3.7.14-management
    ports:
      - 15672:15672